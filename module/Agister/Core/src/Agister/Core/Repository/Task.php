<?php

namespace Agister\Core\Repository;

use DateTime;
use Doctrine\ORM\EntityRepository;
use Agister\Core\Entity;
use Doctrine\ORM\Query\ResultSetMappingBuilder;

/**
 * Task
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class Task extends EntityRepository implements TaskInterface
{

    /**
     * Save Task to database
     *
     * @param Entity\Task $task
     */
    public function save(Entity\Task $task)
    {
        $this->_em->persist($task);
        $this->_em->flush($task);
    }

    /**
     * Find all tasks that end after dateFrom
     *
     * @param  DateTime      $dateFrom
     * @return Entity\Task[]
     */
    public function findAllFromDate(DateTime $dateFrom)
    {
        $query = "SELECT * FROM task t WHERE t.finishesAtMax >= :dateFrom";

        $rsm = new ResultSetMappingBuilder($this->_em);
        $rsm->addRootEntityFromClassMetadata('Agister\Core\Entity\Task', 't');

        $query = $this->_em->createNativeQuery($query, $rsm);
        $query->setParameter('dateFrom', $dateFrom->format('Y-m-d H:i:s'));

        return $query->getResult();
    }

    /**
     * Find single task by ID
     *
     * @param $id
     * @return null|object
     */
    public function findById($id)
    {
        return $this->find($id);
    }

    /**
     * Remove task
     *
     * @param Entity\Task $task
     */
    public function delete(Entity\Task $task)
    {
        $this->_em->remove($task);
        $this->_em->flush($task);
    }

    /**
     * Find when new task should start
     *
     * @return DateTime
     */
    public function findGapForNewTask()
    {
        $query = "
SELECT MAX(t1.finishesAtMax) as dd
FROM task t1 HAVING DATE(dd) >= DATE(NOW());
        ";
        $dbh = $this->getEntityManager()->getConnection()->getWrappedConnection();
        $stmt = $dbh->prepare($query);
        $stmt->execute();
        $value = $stmt->fetchColumn();
        if ($value) {
            return new DateTime($value);
        } else {
            $ret = new DateTime();
            $ret->setTime(0, 0, 0);
            return $ret;
        }
    }

}
